# ===========================================
# MLOps Pipeline - Self-Hosted Runner
# ===========================================
# Pour exÃ©cuter sur votre machine locale avec les donnÃ©es
# dÃ©jÃ  prÃ©sentes (pas besoin de DVC remote)

name: MLOps Pipeline (Local)

on:
  workflow_dispatch:
    inputs:
      model_type:
        description: 'Model type to train'
        required: false
        default: 'cnn'
        type: choice
        options:
          - cnn
          - vit

env:
  DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
  DOCKER_IMAGE_API: ${{ secrets.DOCKER_USERNAME }}/plant-disease-api
  MODEL_TYPE: ${{ github.event.inputs.model_type || 'cnn' }}

jobs:
  # ============================================
  # Train on Self-Hosted Runner (your machine)
  # ============================================
  train-local:
    name: ðŸ§  Train Model (Local)
    runs-on: self-hosted
    
    outputs:
      model_version: ${{ steps.train.outputs.model_version }}
      
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ Setup Python Environment
        shell: pwsh
        run: |
          Write-Host "Python version:"
          python --version
          Write-Host "Installing dependencies..."
          pip install -r requirements-train.txt

      - name: ðŸ§  Run Training
        id: train
        shell: pwsh
        run: |
          Write-Host "ðŸš€ Starting training on local machine..."
          
          # Verify data exists
          Write-Host "Checking data..."
          Get-ChildItem data/raw/PlantVillage | Select-Object -First 5
          
          # Create directories
          New-Item -ItemType Directory -Force -Path models/production | Out-Null
          New-Item -ItemType Directory -Force -Path mlruns | Out-Null
          New-Item -ItemType Directory -Force -Path metrics | Out-Null
          New-Item -ItemType Directory -Force -Path plots | Out-Null
          
          # Set environment
          $env:PYTHONPATH = $PWD
          
          # Run training
          Write-Host "Starting training with model: ${{ env.MODEL_TYPE }}"
          python src/train.py --model ${{ env.MODEL_TYPE }} --dataset data/raw/PlantVillage --config config.yaml
          
          # Generate model version
          $MODEL_VERSION = "v" + (Get-Date -Format "yyyyMMddHHmmss")
          Write-Host "model_version=$MODEL_VERSION" >> $env:GITHUB_OUTPUT
          
          Write-Host "âœ… Training complete! Model version: $MODEL_VERSION"

      - name: ðŸ“¤ Upload Model
        uses: actions/upload-artifact@v4
        with:
          name: trained-model
          path: |
            models/
            metrics/
            plots/

  # ============================================
  # Build API Image (on GitHub-hosted runner)
  # ============================================
  build-api:
    name: ðŸ³ Build API Image
    runs-on: ubuntu-latest
    needs: train-local
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¥ Download Trained Model
        uses: actions/download-artifact@v4
        with:
          name: trained-model
          path: ./

      - name: ðŸ“‹ Verify Model
        run: |
          echo "Checking model artifacts..."
          ls -la models/production/ || echo "No production folder"
          ls -la models/checkpoints/ || echo "No checkpoints"
          
          # Copy best checkpoint to production if needed
          if [ ! -f models/production/model.ckpt ]; then
            BEST=$(find models/checkpoints -name "*.ckpt" | head -1)
            if [ -n "$BEST" ]; then
              mkdir -p models/production
              cp "$BEST" models/production/model.ckpt
            fi
          fi

      - name: ðŸ”§ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ”‘ Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: ðŸ—ï¸ Build and Push API Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/Dockerfile.inference
          push: true
          tags: |
            ${{ env.DOCKER_IMAGE_API }}:${{ needs.train-local.outputs.model_version }}
            ${{ env.DOCKER_IMAGE_API }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: âœ… Summary
        run: |
          echo "# ðŸŒ± Pipeline Complete!" >> $GITHUB_STEP_SUMMARY
          echo "- Model: \`${{ needs.train-local.outputs.model_version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Image: \`${{ env.DOCKER_IMAGE_API }}:latest\`" >> $GITHUB_STEP_SUMMARY
