# ===========================================
# MLOps Automated Pipeline - GitHub Actions
# ===========================================
# Pipeline automatisÃ© complet qui:
# 1. DÃ©tecte les changements DVC (dvc.lock)
# 2. ExÃ©cute le pipeline DVC (prepare_data â†’ train â†’ evaluate â†’ export)
# 3. Enregistre les donnÃ©es et modÃ¨les dans MLflow
# 4. Reconstruit l'image Docker avec le nouveau modÃ¨le
# 5. Push l'image vers Docker Hub (prÃªt pour dÃ©ploiement local)
#
# DÃ©clenchÃ© automatiquement quand:
# - dvc.lock change (nouvelles donnÃ©es)
# - dvc.yaml change (pipeline modifiÃ©)
# - Code d'entraÃ®nement change
# - DÃ©clenchement manuel via workflow_dispatch

name: ðŸ¤– MLOps Automated Pipeline

on:
  push:
    branches: [main, develop]
    paths:
      # DÃ©tection automatique des changements DVC
      - 'dvc.lock'
      - 'dvc.yaml'
      - 'data/**/*.dvc'
      # Ou changements dans le code d'entraÃ®nement
      - 'src/train.py'
      - 'src/models.py'
      - 'src/data_preprocessing.py'
      - 'config.yaml'
  workflow_dispatch:
    inputs:
      force_training:
        description: 'Force training even without DVC changes'
        required: false
        default: false
        type: boolean
      model_type:
        description: 'Model type to train'
        required: false
        default: 'cnn'
        type: choice
        options:
          - cnn
          - vit
      skip_deploy:
        description: 'Skip Docker build and deployment'
        required: false
        default: false
        type: boolean

env:
  PYTHON_VERSION: '3.10'
  MODEL_TYPE: ${{ github.event.inputs.model_type || 'cnn' }}
  DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME || 'your-username' }}
  DOCKER_IMAGE_NAME: plant-disease-mlops
  MLFLOW_TRACKING_URI: ${{ secrets.MLFLOW_TRACKING_URI || 'file:./mlruns' }}

jobs:
  # ============================================
  # Job 1: VÃ©rifier les changements
  # ============================================
  check-changes:
    name: ðŸ” Check DVC Changes
    runs-on: ubuntu-latest
    outputs:
      should_train: ${{ steps.check.outputs.should_train }}
      data_changed: ${{ steps.check.outputs.data_changed }}
      code_changed: ${{ steps.check.outputs.code_changed }}
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Besoin du commit prÃ©cÃ©dent pour comparer

      - name: ðŸ” Detect Changes
        id: check
        run: |
          echo "ðŸ” Checking for changes..."
          
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD || echo "")
          
          # VÃ©rifier les changements DVC
          if echo "$CHANGED_FILES" | grep -E "(dvc\.lock|dvc\.yaml|\.dvc$)"; then
            echo "âœ… DVC changes detected - new data available"
            echo "data_changed=true" >> $GITHUB_OUTPUT
            echo "should_train=true" >> $GITHUB_OUTPUT
          else
            echo "data_changed=false" >> $GITHUB_OUTPUT
          fi
          
          # VÃ©rifier les changements de code
          if echo "$CHANGED_FILES" | grep -E "(src/train\.py|src/models\.py|src/data_preprocessing\.py|config\.yaml)"; then
            echo "âœ… Training code changed"
            echo "code_changed=true" >> $GITHUB_OUTPUT
            echo "should_train=true" >> $GITHUB_OUTPUT
          else
            echo "code_changed=false" >> $GITHUB_OUTPUT
          fi
          
          # Forcer l'entraÃ®nement si demandÃ©
          if [ "${{ github.event.inputs.force_training }}" == "true" ]; then
            echo "âœ… Forced training requested"
            echo "should_train=true" >> $GITHUB_OUTPUT
          fi
          
          # Si aucun changement et pas de force, ne pas entraÃ®ner
          if [ -z "$(echo "$CHANGED_FILES" | grep -E "(dvc\.lock|dvc\.yaml|\.dvc$|src/train\.py|src/models\.py|src/data_preprocessing\.py|config\.yaml)")" ] && [ "${{ github.event.inputs.force_training }}" != "true" ]; then
            echo "â­ï¸ No relevant changes - skipping training"
            echo "should_train=false" >> $GITHUB_OUTPUT
          fi
          
          echo "ðŸ“Š Summary:"
          echo "  - Data changed: $(echo ${{ steps.check.outputs.data_changed }})"
          echo "  - Code changed: $(echo ${{ steps.check.outputs.code_changed }})"
          echo "  - Should train: $(echo ${{ steps.check.outputs.should_train }})"

  # ============================================
  # Job 2: Pull Data from DVC Remote
  # ============================================
  pull-data:
    name: ðŸ“¦ Pull Data (DVC)
    runs-on: ubuntu-latest
    needs: check-changes
    if: needs.check-changes.outputs.should_train == 'true'
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: ðŸ“¦ Install DVC
        run: |
          pip install dvc dvc-s3  # Ajustez selon votre remote DVC
          dvc --version

      - name: ðŸ”‘ Configure DVC Remote
        if: ${{ secrets.DVC_REMOTE_URL != '' }}
        run: |
          # Configurer le remote DVC (S3, Google Drive, etc.)
          if [ -n "${{ secrets.DVC_REMOTE_URL }}" ]; then
            dvc remote add -d storage "${{ secrets.DVC_REMOTE_URL }}" || true
            dvc remote modify storage access_key_id "${{ secrets.DVC_ACCESS_KEY_ID }}" || true
            dvc remote modify storage secret_access_key "${{ secrets.DVC_SECRET_ACCESS_KEY }}" || true
          fi
          
          # Afficher la configuration
          dvc remote list

      - name: ðŸ“¥ Pull Data from DVC
        run: |
          echo "ðŸ“¥ Pulling data from DVC remote..."
          dvc pull -v || echo "âš ï¸ DVC pull failed, using local data if available"
          
          # VÃ©rifier la structure des donnÃ©es
          echo "ðŸ“Š Data structure:"
          ls -la data/ || echo "No data directory"
          ls -la data/raw/ || echo "No raw data directory"
          find data/ -name "*.jpg" -o -name "*.png" | head -10 || echo "No images found"

      - name: ðŸ“¤ Upload Data Artifact
        uses: actions/upload-artifact@v4
        with:
          name: training-data
          path: data/
          retention-days: 1
          if-no-files-found: warn

  # ============================================
  # Job 3: Execute DVC Pipeline
  # ============================================
  run-dvc-pipeline:
    name: ðŸ”„ Run DVC Pipeline
    runs-on: ubuntu-latest
    needs: [check-changes, pull-data]
    if: needs.check-changes.outputs.should_train == 'true'
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¥ Download Data
        uses: actions/download-artifact@v4
        with:
          name: training-data
          path: data/
          if-no-files-found: warn

      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: ðŸ“¦ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install dvc

      - name: ðŸ”§ Setup MLflow
        run: |
          if [ -n "${{ secrets.MLFLOW_TRACKING_URI }}" ]; then
            echo "MLFLOW_TRACKING_URI=${{ secrets.MLFLOW_TRACKING_URI }}" >> $GITHUB_ENV
          else
            echo "MLFLOW_TRACKING_URI=file:./mlruns" >> $GITHUB_ENV
          fi
          echo "MLflow Tracking URI: $MLFLOW_TRACKING_URI"

      - name: ðŸ”„ Run DVC Pipeline
        run: |
          echo "ðŸ”„ Running DVC pipeline (dvc repro)..."
          
          # CrÃ©er les rÃ©pertoires nÃ©cessaires
          mkdir -p models/production models/checkpoints mlruns metrics plots reports
          
          # Exporter PYTHONPATH
          export PYTHONPATH=$GITHUB_WORKSPACE
          
          # ExÃ©cuter le pipeline DVC complet
          dvc repro -v || {
            echo "âš ï¸ DVC repro failed, trying manual execution..."
            
            # Fallback: exÃ©cuter manuellement les Ã©tapes
            echo "ðŸ“Š Step 1: Prepare data..."
            python scripts/prepare_data.py --config config.yaml || echo "âš ï¸ Prepare data failed"
            
            echo "ðŸ§  Step 2: Train model..."
            python src/train.py \
              --model ${{ env.MODEL_TYPE }} \
              --dataset data/raw/PlantVillage \
              --config config.yaml || echo "âš ï¸ Training failed"
            
            echo "ðŸ“ˆ Step 3: Evaluate model..."
            python scripts/evaluate.py --config config.yaml || echo "âš ï¸ Evaluation failed"
            
            echo "ðŸ“¦ Step 4: Export model..."
            python scripts/export_model.py --config config.yaml || echo "âš ï¸ Export failed"
          }
          
          echo "âœ… DVC pipeline completed"

      - name: ðŸ“Š Verify Results
        run: |
          echo "ðŸ“Š Verifying pipeline results..."
          
          echo "ðŸ“ Model checkpoints:"
          ls -lah models/checkpoints/ || echo "No checkpoints"
          
          echo "ðŸ“ Production model:"
          ls -lah models/production/ || echo "No production model"
          
          echo "ðŸ“Š Metrics:"
          cat metrics/train_metrics.json 2>/dev/null || echo "No metrics file"
          
          echo "ðŸ“ˆ Plots:"
          ls -lah plots/ || echo "No plots"

      - name: ðŸ“¤ Upload Model Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: trained-model
          path: |
            models/
            mlruns/
            metrics/
            plots/
          retention-days: 30
          if-no-files-found: warn

  # ============================================
  # Job 4: Build Docker Image
  # ============================================
  build-docker:
    name: ðŸ³ Build Docker Image
    runs-on: ubuntu-latest
    needs: [check-changes, run-dvc-pipeline]
    if: |
      needs.check-changes.outputs.should_train == 'true' &&
      github.event.inputs.skip_deploy != 'true'
    
    outputs:
      image_tag: ${{ steps.meta.outputs.tags }}
      model_version: ${{ steps.version.outputs.version }}
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¥ Download Trained Model
        uses: actions/download-artifact@v4
        with:
          name: trained-model
          path: ./

      - name: ðŸ“‹ Prepare Model for Production
        id: prepare
        run: |
          echo "ðŸ“‹ Preparing model for production..."
          
          # Trouver le meilleur modÃ¨le
          BEST_MODEL=$(find models/checkpoints -name "*.ckpt" -type f 2>/dev/null | head -1)
          
          if [ -n "$BEST_MODEL" ]; then
            echo "âœ… Found model: $BEST_MODEL"
            mkdir -p models/production
            cp "$BEST_MODEL" models/production/model.ckpt
            echo "âœ… Model copied to production"
          elif [ -f "models/production/model.ckpt" ]; then
            echo "âœ… Using existing production model"
          else
            echo "âš ï¸ No model found, creating dummy model..."
            mkdir -p models/production
            python create_dummy_model.py || echo "âš ï¸ Could not create dummy model"
          fi
          
          # VÃ©rifier
          if [ -f "models/production/model.ckpt" ]; then
            SIZE=$(du -h models/production/model.ckpt | cut -f1)
            echo "âœ… Production model ready: $SIZE"
            echo "model_exists=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ No production model available"
            echo "model_exists=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: ðŸ·ï¸ Generate Version Tag
        id: version
        run: |
          VERSION="v$(date +%Y%m%d-%H%M%S)-$(echo ${{ github.sha }} | cut -c1-7)"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Model version: $VERSION"

      - name: ðŸ”§ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ”‘ Login to Docker Hub
        if: ${{ secrets.DOCKER_USERNAME != '' && secrets.DOCKER_PASSWORD != '' }}
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: ðŸ“‹ Extract Metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }}
          tags: |
            type=raw,value=${{ steps.version.outputs.version }}
            type=sha,prefix=
            type=raw,value=latest,enable={{is_default_branch}}

      - name: ðŸ—ï¸ Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/Dockerfile.inference
          push: ${{ secrets.DOCKER_USERNAME != '' && secrets.DOCKER_PASSWORD != '' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            MODEL_VERSION=${{ steps.version.outputs.version }}
            BUILD_DATE=${{ github.event.head_commit.timestamp || github.event.repository.pushed_at }}
            VCS_REF=${{ github.sha }}

      - name: ðŸ“ Output Image Info
        run: |
          echo "âœ… Docker image built successfully!"
          echo "   Image: ${{ env.DOCKER_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }}"
          echo "   Tags: ${{ steps.meta.outputs.tags }}"
          echo "   Model Version: ${{ steps.version.outputs.version }}"
          
          if [ -n "${{ secrets.DOCKER_USERNAME }}" ]; then
            echo "   ðŸš€ Image pushed to Docker Hub"
            echo "   Pull with: docker pull ${{ env.DOCKER_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }}:${{ steps.version.outputs.version }}"
          else
            echo "   âš ï¸ Docker Hub credentials not set, image not pushed"
          fi

  # ============================================
  # Job 5: Summary and Notifications
  # ============================================
  summary:
    name: ðŸ“Š Pipeline Summary
    runs-on: ubuntu-latest
    needs: [check-changes, run-dvc-pipeline, build-docker]
    if: always()
    
    steps:
      - name: ðŸ“Š Generate Summary
        run: |
          echo "# ðŸŒ± MLOps Automated Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“‹ Pipeline Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Step | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ” Check Changes | ${{ needs.check-changes.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”„ DVC Pipeline | ${{ needs.run-dvc-pipeline.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ³ Docker Build | ${{ needs.build-docker.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.run-dvc-pipeline.result }}" == "success" ]; then
            echo "## âœ… Training Completed" >> $GITHUB_STEP_SUMMARY
            echo "- Model trained and registered in MLflow" >> $GITHUB_STEP_SUMMARY
            echo "- Metrics and plots generated" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.build-docker.result }}" == "success" ]; then
            echo "## ðŸ³ Docker Image Ready" >> $GITHUB_STEP_SUMMARY
            echo "- Image: \`${{ env.DOCKER_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- Version: \`${{ needs.build-docker.outputs.model_version }}\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸš€ Deploy Locally" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
            echo "# Pull the new image" >> $GITHUB_STEP_SUMMARY
            echo "docker pull ${{ env.DOCKER_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }}:${{ needs.build-docker.outputs.model_version }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "# Update docker-compose.yml with new tag" >> $GITHUB_STEP_SUMMARY
            echo "# Then restart services" >> $GITHUB_STEP_SUMMARY
            echo "docker-compose -f docker/docker-compose.yml up -d" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“š Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. Check MLflow UI for training metrics" >> $GITHUB_STEP_SUMMARY
          echo "2. Pull the new Docker image locally" >> $GITHUB_STEP_SUMMARY
          echo "3. Deploy using docker-compose" >> $GITHUB_STEP_SUMMARY
          echo "4. Test the API: \`curl http://localhost:8000/health\`" >> $GITHUB_STEP_SUMMARY

