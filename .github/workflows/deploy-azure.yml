name: Deploy to Azure

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'src/api.py'
      - 'src/models.py'
      - 'requirements-inference.txt'
      - 'docker/Dockerfile.inference'
      - 'k8s/**'

jobs:
  build-and-deploy:
    runs-on: self-hosted  # Runs on your laptop (which is already logged in via 'az login')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    # No need for azure/login action because your laptop is already authenticated!
    
    - name: Login to ACR (Local)
      run: |
        az acr login --name ${{ secrets.ACR_USERNAME }}

    - name: Build and Push Inference Image
      run: |
        # Build using the local Docker daemon
        docker build -t ${{ secrets.ACR_LOGIN_SERVER }}/plant-disease-api:${{ github.sha }} -f docker/Dockerfile.inference .
        docker push ${{ secrets.ACR_LOGIN_SERVER }}/plant-disease-api:${{ github.sha }}

    - name: Connect to AKS
      run: |
        az aks get-credentials --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} --name ${{ secrets.AKS_CLUSTER_NAME }} --overwrite-existing

    - name: Deploy to AKS
      run: |
        # Update image in deployment manifest
        sed -i "s|image: .*|image: ${{ secrets.ACR_LOGIN_SERVER }}/plant-disease-api:${{ github.sha }}|g" k8s/deployment.yaml
        
        kubectl apply -f k8s/namespace.yaml
        kubectl apply -f k8s/deployment.yaml
        kubectl apply -f k8s/service.yaml
