name: Deploy to Azure

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'src/api.py'
      - 'src/models.py'
      - 'requirements-inference.txt'
      - 'docker/Dockerfile.inference'
      - 'k8s/**'

jobs:
  build-and-deploy:
    runs-on: self-hosted  # Runs on your laptop (which is already logged in via 'az login')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    # No need for azure/login action because your laptop is already authenticated!
    
    - name: Login to ACR (Token Method)
      run: |
        # Sanitize server name
        ACR_SERVER=$(echo "${{ secrets.ACR_LOGIN_SERVER }}" | tr -d '[:space:]')
        ACR_NAME=$(echo $ACR_SERVER | cut -d'.' -f1)
        
        # Get access token from Azure CLI and login to Docker
        # This avoids the "hang" of direct az acr login and the "interactive" error of docker login
        TOKEN=$(az acr login --name $ACR_NAME --expose-token --output tsv --query accessToken)
        echo $TOKEN | docker login $ACR_SERVER -u 00000000-0000-0000-0000-000000000000 --password-stdin

    - name: Verify Azure Login
      run: az account show

    - name: Build and Push Inference Image
      run: |
        # Sanitize the secret (remove whitespace/newlines)
        ACR_SERVER=$(echo "${{ secrets.ACR_LOGIN_SERVER }}" | tr -d '[:space:]')
        
        echo "Building image for registry: $ACR_SERVER"
        
        # Build using explicit command with sanitized variable
        docker image build \
          --file docker/Dockerfile.inference \
          --tag "$ACR_SERVER/plant-disease-api:${{ github.sha }}" \
          .
        
        docker push "$ACR_SERVER/plant-disease-api:${{ github.sha }}"

    - name: Connect to AKS
      run: |
        az aks get-credentials --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} --name ${{ secrets.AKS_CLUSTER_NAME }} --overwrite-existing

    - name: Deploy to AKS
      run: |
        # Sanitize the secret again for the sed command
        ACR_SERVER=$(echo "${{ secrets.ACR_LOGIN_SERVER }}" | tr -d '[:space:]')
        
        # Update image in deployment manifest
        sed -i "s|image: .*|image: $ACR_SERVER/plant-disease-api:${{ github.sha }}|g" k8s/deployment.yaml
        
        kubectl apply -f k8s/namespace.yaml
        kubectl apply -f k8s/deployment.yaml
        kubectl apply -f k8s/service.yaml
