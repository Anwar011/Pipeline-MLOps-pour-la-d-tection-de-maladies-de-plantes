# ===========================================
# MLOps Pipeline - WSL Self-Hosted Runner
# ===========================================
# ExÃ©cute sur WSL avec accÃ¨s aux donnÃ©es locales

name: MLOps Pipeline (WSL)

on:
  workflow_dispatch:
    inputs:
      model_type:
        description: 'Model type to train'
        required: false
        default: 'cnn'
        type: choice
        options:
          - cnn
          - vit

env:
  DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
  DOCKER_IMAGE_API: ${{ secrets.DOCKER_USERNAME }}/plant-disease-api
  MODEL_TYPE: ${{ github.event.inputs.model_type || 'cnn' }}

jobs:
  # ============================================
  # Train on WSL Self-Hosted Runner
  # ============================================
  train-wsl:
    name: ðŸ§  Train Model (WSL)
    runs-on: self-hosted
    defaults:
      run:
        shell: cmd
    
    outputs:
      model_version: ${{ steps.train.outputs.model_version }}
      
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ Setup Python Environment
        run: |
          wsl python3 --version
          wsl python3 -m venv .venv
          wsl .venv/bin/pip install --upgrade pip
          wsl .venv/bin/pip install -r requirements-train.txt

      - name: ðŸš€ Start MLflow Server
        run: |
          cd docker
          wsl docker-compose up -d mlflow-server
          timeout /t 10 /nobreak
          wsl docker-compose ps
          echo MLflow server ready at http://localhost:5000

      - name: ðŸ§  Run Training
        id: train
        run: |
          echo Starting training on WSL...
          wsl ls -la data/raw/PlantVillage
          wsl mkdir -p models/production mlruns metrics plots
          wsl bash -c "export PYTHONPATH=$(wsl pwd) && export MLFLOW_TRACKING_URI=http://localhost:5000 && .venv/bin/python src/train.py --model ${{ env.MODEL_TYPE }} --dataset data/raw/PlantVillage --config config.yaml"
          for /f %%i in ('wsl date +%%Y%%m%%d%%H%%M%%S') do set MODEL_VERSION=v%%i
          echo model_version=%MODEL_VERSION% >> %GITHUB_OUTPUT%
          echo Training complete! Model: %MODEL_VERSION%

      - name: ðŸ“¤ Upload Model
        uses: actions/upload-artifact@v4
        with:
          name: trained-model
          path: |
            models/
            metrics/
            plots/

  # ============================================
  # Build API Image (on GitHub-hosted runner)
  # ============================================
  build-api:
    name: ðŸ³ Build API Image
    runs-on: ubuntu-latest
    needs: train-wsl
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¥ Download Trained Model
        uses: actions/download-artifact@v4
        with:
          name: trained-model
          path: ./

      - name: ðŸ“‹ Verify Model
        run: |
          echo "Checking model artifacts..."
          ls -la models/production/ || echo "No production folder"
          ls -la models/checkpoints/ || echo "No checkpoints"
          
          # Copy best checkpoint to production if needed
          if [ ! -f models/production/model.ckpt ]; then
            BEST=$(find models/checkpoints -name "*.ckpt" 2>/dev/null | head -1)
            if [ -n "$BEST" ]; then
              mkdir -p models/production
              cp "$BEST" models/production/model.ckpt
              echo "âœ… Copied $BEST to production"
            fi
          fi
          
          echo "Production model:"
          ls -lh models/production/

      - name: ðŸ”§ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ”‘ Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: ðŸ—ï¸ Build and Push API Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/Dockerfile.inference
          push: true
          tags: |
            ${{ env.DOCKER_IMAGE_API }}:${{ needs.train-wsl.outputs.model_version }}
            ${{ env.DOCKER_IMAGE_API }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            MODEL_VERSION=${{ needs.train-wsl.outputs.model_version }}

      - name: âœ… Summary
        run: |
          echo "# ðŸŒ± Pipeline Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## âœ… Training Results" >> $GITHUB_STEP_SUMMARY
          echo "- **Model Version**: \`${{ needs.train-wsl.outputs.model_version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Model Type**: \`${{ env.MODEL_TYPE }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ³ Docker Image" >> $GITHUB_STEP_SUMMARY
          echo "- **Image**: \`${{ env.DOCKER_IMAGE_API }}:latest\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: \`${{ env.DOCKER_IMAGE_API }}:${{ needs.train-wsl.outputs.model_version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“Š MLflow" >> $GITHUB_STEP_SUMMARY
          echo "View training results at: http://localhost:5000" >> $GITHUB_STEP_SUMMARY
