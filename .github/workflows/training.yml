name: Automated Training

on:
  workflow_dispatch:
  push:
    paths:
      - 'data/**'
      - 'dvc.lock'
      - 'src/train.py'
      - 'src/models.py'
      - 'requirements-train.txt'

jobs:
  train:
    runs-on: self-hosted  # Requires a self-hosted runner (your laptop)
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Build Training Image
      run: |
        docker build -t anwar011/plant-disease-train:latest -f docker/Dockerfile.train .

    - name: Run Training
      run: |
        # Mount data and models directories to persist outputs
        docker run --rm \
          --gpus all \
          -v $(pwd)/data:/app/data \
          -v $(pwd)/models:/app/models \
          -v $(pwd)/experiments:/app/experiments \
          -v $(pwd)/mlruns:/app/mlruns \
          anwar011/plant-disease-train:latest \
          python src/train.py

    - name: Commit and Push DVC/MLflow updates (Optional)
      run: |
        # This step would commit updated dvc.lock or push to MLflow
        echo "Training complete. Model saved to models/production/"
